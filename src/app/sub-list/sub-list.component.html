<ion-header>
  <ion-toolbar>
    <ion-title>Accueil</ion-title>
  </ion-toolbar>
</ion-header>
<ion-content>
  <ion-refresher slot="fixed" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content></ion-refresher-content>
  </ion-refresher>
  <div class="main-content">
    @if(!noSub) {
        @if(userSubData$ | async; as subData) {
          @if(subData.length > 0) {
            <section class="summary-section">
              <app-donut-chart [subData]="subData"></app-donut-chart>
            </section>
            <div class="expenses-summary">
              <div class="expense-card">
                <span class="expense-label">Dépenses mensuelles</span>
                <span class="expense-value">{{ (monthlyExpenses$ | async) || 0 }} CHF</span>
              </div>
              <div class="expense-card">
                <span class="expense-label">Dépenses annuelles</span>
                <span class="expense-value">{{ (yearlyExpenses$ | async) || 0 }} CHF</span>
              </div>
            </div>
          }
        }
        @if(!(userSubData$ | async)?.length){
          <ion-loading trigger="open-loading" message="Loading..." [duration]="3000" spinner="circles"></ion-loading>
        }

        <div class="filter-container">
          <div class="filter-pill" [class.active]="selectedCategories.length > 0">
            <ion-icon name="funnel-outline"></ion-icon>
            <span class="filter-label">Catégorie</span>
            @if (categoryFilterCount > 0) {
              <span class="filter-badge">{{ categoryFilterCount }}</span>
            }
            <ion-select 
              aria-label="Catégorie" 
              toggleIcon="none" 
              multiple="true"
              [(ngModel)]="tempSelectedCategories" 
              (ionDismiss)="onCategoryDismiss()"
              interface="popover"
              class="filter-select-hidden">
              @for (category of subscriptionCategories; track category) {
                <ion-select-option value="{{ category }}">{{ category }}</ion-select-option>
              }
            </ion-select>
          </div>
          <div class="filter-pill" [class.active]="selectedRenewals.length > 0">
            <ion-icon name="calendar-outline"></ion-icon>
            <span class="filter-label">Renouvellement</span>
            @if (renewalFilterCount > 0) {
              <span class="filter-badge">{{ renewalFilterCount }}</span>
            }
            <ion-select 
              aria-label="Renouvellement" 
              toggleIcon="none"
              multiple="true"
              [(ngModel)]="tempSelectedRenewals" 
              (ionDismiss)="onRenewalDismiss()"
              interface="popover"
              class="filter-select-hidden">
              @for (renewal of subscriptionRenewal; track renewal) {
                <ion-select-option value="{{ renewal }}">{{ renewal }}</ion-select-option>
              }
            </ion-select>
          </div>
          @if (hasActiveFilters) {
            <button type="button" class="reset-filters-button" (click)="resetFilters()">× Réinitialiser</button>
          }
        </div>  

        <ion-list>
          @for (sub of userSubData$ | async; track sub) {
            <ion-item-sliding>
              <ion-item class="subscription-card no-border">
                <div class="subscription-logo">
                  <img
                    [src]="getLogoUrl(sub)"
                    alt="{{ sub.companyName }}"
                    referrerpolicy="no-referrer"
                    (error)="onImageError($event)"
                  />
                </div>
                <div class="subscription-info">
                  <span class="subscription-name">{{ sub.companyName }}</span>
                  <span class="subscription-meta">Catégorie : {{ sub.category }}</span>
                </div>
                <div class="subscription-amount">
                  <span class="amount">{{ sub.amount }}.-</span>
                  <span class="period">/ {{ sub.renewal }}</span>
                </div>
                <button type="button" class="details-link" (click)="subDetails(sub)">Détails</button>
              </ion-item>
              <ion-item-options side="end" class="subscription-item-options">
                <ion-item-option (click)="updateSub(sub)" class="subscription-item-option" color="primary">Modifier</ion-item-option>
                <ion-item-option color="danger" (click)="deleteSub(sub)" class="subscription-item-option">Effacer</ion-item-option>
              </ion-item-options>
            </ion-item-sliding>
          }
        </ion-list>
    } @else {
      <div class="filter-container">
        <div class="filter-pill" [class.active]="selectedCategories.length > 0">
          <ion-icon name="funnel-outline"></ion-icon>
          <span class="filter-label">Catégorie</span>
          @if (categoryFilterCount > 0) {
            <span class="filter-badge">{{ categoryFilterCount }}</span>
          }
          <ion-select 
            aria-label="Catégorie" 
            toggleIcon="none" 
            multiple="true"
            [(ngModel)]="tempSelectedCategories" 
            (ionDismiss)="onCategoryDismiss()"
            interface="popover"
            class="filter-select-hidden">
            @for (category of subscriptionCategories; track category) {
              <ion-select-option value="{{ category }}">{{ category }}</ion-select-option>
            }
          </ion-select>
        </div>
        <div class="filter-pill" [class.active]="selectedRenewals.length > 0">
          <ion-icon name="calendar-outline"></ion-icon>
          <span class="filter-label">Renouvellement</span>
          @if (renewalFilterCount > 0) {
            <span class="filter-badge">{{ renewalFilterCount }}</span>
          }
          <ion-select 
            aria-label="Renouvellement" 
            toggleIcon="none"
            multiple="true"
            [(ngModel)]="tempSelectedRenewals" 
            (ionDismiss)="onRenewalDismiss()"
            interface="popover"
            class="filter-select-hidden">
            @for (renewal of subscriptionRenewal; track renewal) {
              <ion-select-option value="{{ renewal }}">{{ renewal }}</ion-select-option>
            }
          </ion-select>
        </div>
        @if (hasActiveFilters) {
          <button type="button" class="reset-filters-button" (click)="resetFilters()">× Réinitialiser</button>
        }
      </div>
      <ion-text class="ion-text-center ion-align-items-center">
        <h1 class="flex">Aucun abonnement pour le moment</h1>
        <ion-button class="empty-cta" routerLink="/add">+ Ajouter mon premier abonnement</ion-button>
      </ion-text>
    }
  </div>
</ion-content>
