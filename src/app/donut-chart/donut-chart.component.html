@if (subData) {
<div id="chart" class="chart-wrapper" [class.segment-selected]="selectedSegmentIndex !== null">
  <apx-chart
    class="ion-justify-content-start"
    [series]="chartOptions.series!"
    [chart]="chartOptions.chart!"
    [labels]="chartOptions.labels!"
    [dataLabels]="chartOptions.dataLabels!"
    [title]="chartOptions.title!"
    [fill]="chartOptions.fill!"
    [states]="chartOptions.states!"
    [plotOptions]="chartOptions.plotOptions!"
    [stroke]="chartOptions.stroke!"
    [theme]="chartOptions.theme!"
    [responsive]="chartOptions.responsive!"
  ></apx-chart>
  
  <!-- Overlay pour bloquer les cliques sur le donut -->
  @if (selectedSegmentIndex !== null) {
    <div class="donut-overlay" (click)="resetSegmentHighlight()"></div>
  }
  
  <!-- Texte central overlay -->
  <div class="chart-center-text">
    <div class="center-amount">{{ centerText.title }}</div>
    <div class="center-label">{{ centerText.subtitle }}</div>
  </div>
  
  <!-- Légende personnalisée sous forme de chips scrollables - tous les abonnements -->
  <div class="legend-chips">
    @if (allSubscriptions && allSubscriptions.length > 0) {
      @for (sub of allSubscriptions; track $index) {
        <div class="chip" (click)="onChipClick($index)" [class.selected]="selectedSegmentIndex === $index">
          <div class="chip-color" [style.background-color]="getChipColor($index)"></div>
          <span class="chip-name">{{ sub.companyName }}</span>
          <span class="chip-amount">{{ sub.amount | number:'1.0-0' }} CHF</span>
          <span class="chip-percent">{{ getPercentage(sub.amount) }}%</span>
        </div>
      }
    } @else {
      <span style="color: var(--app-text-muted); font-size: 12px;">No subscriptions</span>
    }
  </div>
</div>
} @else {
  <ion-loading trigger="open-loading" message="Loading..." [duration]="3000" spinner="circles"></ion-loading>
  <p>Loading...</p>
}